<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secure Blink Chat</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #login, #chatUI { max-width: 400px; margin: auto; }
    #messages { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;}
    #onlineUsers { margin-bottom: 10px; }
    #onlineUsers li { list-style: none; }
    input, button { padding: 8px; margin: 4px 0; width: 100%; box-sizing: border-box; }
    .msg { margin-bottom: 5px; }
    .timestamp { color: #888; font-size: 0.8em; margin-right: 5px; }
    #anonBtn { background: #eee; }
    #clearChat { background: #f88; color: white; }
  </style>
</head>
<body>
  <div id="login">
    <h2>Sign In</h2>
    <input id="email"    type="email"    placeholder="Email (leave blank for guest)" />
    <input id="password" type="password" placeholder="Password (leave blank for guest)" />
    <button id="btnLogin">Log In / Register</button>
    <button id="btnAnon"  style="margin-top:8px;">Continue as Guest</button>
  </div>  <div id="chatUI" style="display:none;">
    <h2>Blink Chat</h2>
    <div>
      Signed in as <strong id="displayName"></strong>
      <button id="btnLogout" style="width:auto; float:right;">Log Out</button>
    </div>
    <h4>Online Users</h4>
    <ul id="onlineUsers"></ul>
    <div id="messages"></div>
    <input id="input" placeholder="Type a messageâ€¦" />
    <button id="send">Send</button>
    <button id="clearChat">Clear Chat</button>
  </div>  <script type="module">
    import { initializeApp }    from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getDatabase, ref, push, onChildAdded,
      onValue, set, serverTimestamp, onDisconnect, remove
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signInAnonymously,
      onAuthStateChanged,
      signOut,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // â”€â”€â”€ 1. CONFIG & INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const firebaseConfig = {
      apiKey: "AIzaSyAYA5pjoxFuxH2Kzo_eDSqTZPDkYXOZU8s",
      authDomain: "blink-chat-hd.firebaseapp.com",
      databaseURL: "https://blink-chat-hd-default-rtdb.firebaseio.com",
      projectId: "blink-chat-hd",
      storageBucket: "blink-chat-hd.appspot.com",
      messagingSenderId: "712857952183",
      appId: "1:712857952183:web:47a623b806093d3f021232",
      measurementId: "G-T9TWHCT6KP"
    };
    const app  = initializeApp(firebaseConfig);
    const db   = getDatabase(app);
    const auth = getAuth(app);

    // â”€â”€â”€ 2. UI REFS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const loginDiv    = document.getElementById('login');
    const chatDiv     = document.getElementById('chatUI');
    const emailEl     = document.getElementById('email');
    const passEl      = document.getElementById('password');
    const btnLogin    = document.getElementById('btnLogin');
    const btnAnon     = document.getElementById('btnAnon');
    const btnLogout   = document.getElementById('btnLogout');
    const nameEl      = document.getElementById('displayName');
    const messagesEl  = document.getElementById('messages');
    const inputEl     = document.getElementById('input');
    const sendBtn     = document.getElementById('send');
    const clearBtn    = document.getElementById('clearChat');
    const usersList   = document.getElementById('onlineUsers');

    // â”€â”€â”€ 3. AUTH FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    btnLogin.onclick = () => {
      const email = emailEl.value.trim();
      const pass  = passEl.value.trim();
      if (!email || !pass) {
        alert("Email & password required for registered users. Or click 'Continue as Guest'.");
        return;
      }
      signInWithEmailAndPassword(auth, email, pass)
        .catch(err => {
          if (err.code === 'auth/user-not-found') {
            return createUserWithEmailAndPassword(auth, email, pass);
          } else {
            alert(err.message);
          }
        });
    };

    btnAnon.onclick = () => {
      signInAnonymously(auth)
        .catch(err => alert("Anonymous sign-in failed: " + err.message));
    };

    btnLogout.onclick = () => signOut(auth);

    onAuthStateChanged(auth, user => {
      if (user) {
        loginDiv.style.display = 'none';
        chatDiv.style.display  = 'block';
        // For both anon and registered, prompt for name if not set
        if (!user.displayName) {
          const dn = prompt("Enter your display name:", user.isAnonymous ? "" : "Anon");
          updateProfile(user, { displayName: dn || (user.isAnonymous ? 'Guest' : 'Anon') })
            .then(() => setupAfterAuth(user))
            .catch(console.error);
        } else {
          setupAfterAuth(user);
        }
      } else {
        chatDiv.style.display  = 'none';
        loginDiv.style.display = 'block';
        messagesEl.innerHTML = '';
        usersList.innerHTML  = '';
      }
    });

    function setupAfterAuth(user) {
      nameEl.textContent = user.displayName;
      initPresence(user);
      startChat();
      watchUsers();
    }

    // â”€â”€â”€ 4. PRESENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function initPresence(user) {
      const presRef = ref(db, `presence/${user.uid}`);
      set(presRef, { name: user.displayName, online: true });
      onDisconnect(presRef).set({ name: user.displayName, online: false });
    }

    function watchUsers() {
      const presRoot = ref(db, 'presence');
      onValue(presRoot, snap => {
        usersList.innerHTML = '';
        snap.forEach(child => {
          const { name, online } = child.val();
          const li = document.createElement('li');
          li.textContent = name + (online ? ' ðŸŸ¢' : ' ðŸ”´');
          usersList.appendChild(li);
        });
      });
    }

    // â”€â”€â”€ 5. CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startChat() {
      const chatsRef = ref(db, 'chats');
      onChildAdded(chatsRef, snapshot => {
        const { text, ts, sender } = snapshot.val();
        const div = document.createElement('div');
        div.classList.add('msg');
        const time = new Date(ts).toLocaleTimeString();
        div.innerHTML = `<span class="timestamp">[${time}]</span><strong>${sender}:</strong> ${text}`;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    function sendMessage() {
      const txt = inputEl.value.trim();
      if (!txt) return;
      push(ref(db, 'chats'), {
        text: txt,
        ts: serverTimestamp(),
        sender: auth.currentUser.displayName
      });
      inputEl.value = '';
    }

    function clearChat() {
      if (confirm('Clear all chat history for everyone?')) {
        remove(ref(db, 'chats')).catch(err => alert('Failed to clear: ' + err.message));
        messagesEl.innerHTML = '';
      }
    }

    sendBtn.onclick = sendMessage;
    inputEl.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });
    clearBtn.onclick = clearChat;
  </script></body>
</html>